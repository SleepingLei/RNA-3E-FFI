# æ•°æ®å½’ä¸€åŒ–ä¿®å¤è¯´æ˜

## ğŸ¯ é—®é¢˜æ ¹æº

**çœŸæ­£çš„NaNåŸå› **ï¼šæ•°æ®é¢„å¤„ç†é˜¶æ®µï¼ŒæŸäº›attributesçš„æ•°å€¼èŒƒå›´è¿‡å¤§ï¼Œå¯¼è‡´forward passæ—¶æ•°å€¼æº¢å‡ºã€‚

### å‘ç°çš„é—®é¢˜

```python
# ä» check_data_and_model.py çš„è¾“å‡º
Nonbonded attributes:
  Max: 2,541,886.750000  â† LJå‚æ•°Aå¯è¾¾250ä¸‡ï¼
  âš ï¸  å­˜åœ¨æå¤§å€¼ (>1000000)

# å¯¼è‡´
Model output:
  Mean: nan  â† forward passåç«‹å³NaN
```

---

## âœ… ä¿®å¤å†…å®¹

### 1. Nonbonded Attributes å½’ä¸€åŒ–

**ä½ç½®**: `scripts/03_build_dataset.py:271-283`

**é—®é¢˜**: Lennard-Joneså‚æ•°Aå’ŒBçš„åŸå§‹å€¼å¯è¾¾ 10^6 é‡çº§

**ä¿®å¤**: ä½¿ç”¨å¯¹æ•°å˜æ¢

```python
# Before
nonbonded_edge_attr = [[lj_A, lj_B, dist], ...]  # lj_A, lj_B å¯è¾¾ 10^6

# After
lj_a_log = torch.log(lj_a + 1.0)  # å‹ç¼©åˆ° ~15
lj_b_log = torch.log(lj_b + 1.0)  # å‹ç¼©åˆ° ~15
nonbonded_edge_attr = torch.stack([lj_a_log, lj_b_log, dist], dim=1)
```

**æ•ˆæœ**:
- LJ_A: 2,541,886 â†’ log(2541887) â‰ˆ 14.75
- LJ_B: ç±»ä¼¼å‹ç¼©
- æ•°å€¼èŒƒå›´å˜ä¸º [0, ~20]ï¼Œä¸å†æº¢å‡º

---

### 2. Angle Attributes å½’ä¸€åŒ–

**ä½ç½®**: `scripts/03_build_dataset.py:292-300`

**é—®é¢˜**: è§’åº¦force constant (k) èŒƒå›´ 40-140

**ä¿®å¤**: çº¿æ€§å½’ä¸€åŒ–åˆ° [0, 1]

```python
# triple_attr: [theta_eq, k]
theta_eq_norm = theta_eq / 180.0  # è§’åº¦å½’ä¸€åŒ– (åº¦ â†’ [0,1])
k_angle_norm = k_angle / 200.0    # force constantå½’ä¸€åŒ–
```

---

### 3. Dihedral Attributes å½’ä¸€åŒ–

**ä½ç½®**: `scripts/03_build_dataset.py:302-313`

**é—®é¢˜**: barrier height (phi_k) èŒƒå›´ 0-20

**ä¿®å¤**: çº¿æ€§å½’ä¸€åŒ–

```python
# quadra_attr: [phi_k, per, phase]
phi_k_norm = phi_k / 20.0         # barrier heightå½’ä¸€åŒ–
per_norm = per / 6.0              # periodicityå½’ä¸€åŒ– (æœ€å¤§6)
phase_norm = phase / (2 * Ï€)      # ç›¸ä½è§’å½’ä¸€åŒ– (radians â†’ [0,1])
```

---

## ğŸ”„ å›é€€çš„ä¸å¿…è¦ä¿®æ”¹

ä¹‹å‰ä¸ºäº†"ä¿®å¤"NaNï¼Œæˆ‘åšäº†å¾ˆå¤šå¤æ‚çš„å°è¯•ï¼Œä½†å®ƒä»¬éƒ½ä¸æ˜¯æ ¹æœ¬åŸå› ï¼š

### âŒ å›é€€å†…å®¹

1. **å¯¹æ•°ç©ºé—´æƒé‡å‚æ•°åŒ–**
   ```python
   # ä¹‹å‰çš„å¤æ‚å®ç°ï¼ˆå·²å›é€€ï¼‰
   self.angle_weight_raw = nn.Parameter(torch.log(torch.tensor(0.333)))
   def get_angle_weight(self):
       return torch.exp(torch.clamp(self.angle_weight_raw, min=-5, max=5))

   # å›é€€åˆ°ç®€å•å®ç°
   self.angle_weight = nn.Parameter(torch.tensor(0.333))
   ```

2. **Propertyè£…é¥°å™¨æ”¹æ–¹æ³•** - å·²å›é€€ï¼Œç›´æ¥ä½¿ç”¨ `self.angle_weight`

3. **è¾“å‡ºå±‚LayerNormæ¡ä»¶åˆ¤æ–­** - ä¿æŒç¡¬ç¼–ç ï¼ˆè¾“å‡ºå±‚å§‹ç»ˆéœ€è¦å½’ä¸€åŒ–ï¼‰

### âœ… ä¿ç•™çš„æœ‰ç”¨åŠŸèƒ½

1. **æ¢¯åº¦ç›‘æ§** (`--monitor_gradients`)
2. **Loss functioné…ç½®è¾“å‡º**
3. **å¯é…ç½®çš„æ¢¯åº¦è£å‰ª** (`--grad_clip`)
4. **è‡ªé€‚åº”æ¢¯åº¦è£å‰ª**ï¼ˆcosine lossç”¨10.0ï¼Œå…¶ä»–ç”¨5.0ï¼‰

---

## ğŸš€ å¦‚ä½•åº”ç”¨ä¿®å¤

### æ­¥éª¤1: é‡æ–°ç”Ÿæˆæ•°æ®é›†

```bash
# é‡æ–°è¿è¡Œæ•°æ®ç”Ÿæˆè„šæœ¬ï¼ˆä¼šè‡ªåŠ¨åº”ç”¨å½’ä¸€åŒ–ï¼‰
python scripts/03_build_dataset.py \
    --hariboss_csv hariboss/Complexes.csv \
    --output_dir data/processed/graphs \
    --add_multi_hop \
    --add_nonbonded_edges
```

**æ³¨æ„**: è¿™ä¼šè¦†ç›–ç°æœ‰çš„graphæ–‡ä»¶ï¼å¦‚æœéœ€è¦ä¿ç•™æ—§æ–‡ä»¶ï¼š
```bash
# å…ˆå¤‡ä»½
mv data/processed/graphs data/processed/graphs_old

# ç„¶åé‡æ–°ç”Ÿæˆ
python scripts/03_build_dataset.py ...
```

---

### æ­¥éª¤2: éªŒè¯ä¿®å¤

```bash
# æ£€æŸ¥æ–°ç”Ÿæˆçš„æ•°æ®
python scripts/check_data_and_model.py
```

**é¢„æœŸè¾“å‡º**:
```
Nonbonded attributes:
  Max: 15.45  â† ä¸å†æ˜¯250ä¸‡ï¼
  âœ“ æ•°å€¼æ­£å¸¸

Model output:
  Mean: 0.023  â† ä¸å†æ˜¯NaNï¼
  âœ“ æ•°å€¼æ­£å¸¸

âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼
```

---

### æ­¥éª¤3: å¼€å§‹è®­ç»ƒ

```bash
python scripts/04_train_model.py \
    --embeddings_path data/processed/ligand_embeddings.h5 \
    --output_dim 1536 \
    --batch_size 4 \
    --num_epochs 300 \
    --lr 5e-4 \
    --use_multi_hop \
    --use_nonbonded \
    --use_gate \
    --num_layers 6 \
    --dropout 0.1 \
    --loss_fn cosine \
    --monitor_gradients \
    --output_dir models/checkpoints_with_normalized_data
```

**é¢„æœŸç»“æœ**:
```
Epoch 1/300
  Batch 0: Grad norm before clip = 25.34  â† æ­£å¸¸èŒƒå›´
Train Loss: 0.95, Cosine Sim: 0.05
  Angle weight: 0.333
  Dihedral weight: 0.333
  Nonbonded weight: 0.333  â† éƒ½æ­£å¸¸

Epoch 2/300
Train Loss: 0.89, Cosine Sim: 0.11  â† Lossä¸‹é™
```

---

## ğŸ“Š å½’ä¸€åŒ–å‰åå¯¹æ¯”

| Attribute | åŸå§‹èŒƒå›´ | å½’ä¸€åŒ–å | æ–¹æ³• |
|-----------|---------|---------|------|
| LJ_A | [0, 2.5Ã—10^6] | [0, ~15] | log(x+1) |
| LJ_B | [0, 10^5] | [0, ~12] | log(x+1) |
| theta_eq | [0, 180Â°] | [0, 1] | x/180 |
| k_angle | [40, 140] | [0.2, 0.7] | x/200 |
| phi_k | [0, 20] | [0, 1] | x/20 |
| per | [1, 6] | [0.17, 1] | x/6 |
| phase | [0, 2Ï€] | [0, 1] | x/(2Ï€) |

---

## âš ï¸ é‡è¦æ³¨æ„äº‹é¡¹

### 1. æ—§çš„checkpointä¸å…¼å®¹

å¦‚æœæ‚¨æœ‰æ—§çš„è®­ç»ƒcheckpointï¼Œå®ƒä»¬æ˜¯åŸºäº**æœªå½’ä¸€åŒ–**çš„æ•°æ®è®­ç»ƒçš„ï¼Œ**ä¸èƒ½**ç›´æ¥ç”¨äºæ–°æ•°æ®ã€‚

**è§£å†³æ–¹æ¡ˆ**:
- ä»å¤´å¼€å§‹è®­ç»ƒï¼ˆæ¨èï¼‰
- æˆ–ä¿ç•™æ—§æ•°æ®ï¼Œç»§ç»­ä½¿ç”¨æ—§checkpoint

### 2. æ•°æ®ä¸€è‡´æ€§

ç¡®ä¿è®­ç»ƒå’Œæ¨ç†ä½¿ç”¨**ç›¸åŒç‰ˆæœ¬**çš„å½’ä¸€åŒ–ï¼š
- è®­ç»ƒ: ä½¿ç”¨å½’ä¸€åŒ–åçš„æ•°æ®
- æ¨ç†: è¾“å…¥æ•°æ®ä¹Ÿè¦ç»è¿‡ç›¸åŒçš„å½’ä¸€åŒ–

### 3. å·²å½’ä¸€åŒ–çš„æç¤º

æ–°ç”Ÿæˆçš„graphæ–‡ä»¶å·²ç»åŒ…å«å½’ä¸€åŒ–çš„attributesï¼Œ**ä¸éœ€è¦**åœ¨æ¨¡å‹ä¸­å†æ¬¡å½’ä¸€åŒ–ã€‚

---

## ğŸ”¬ æŠ€æœ¯ç»†èŠ‚

### ä¸ºä»€ä¹ˆç”¨logå˜æ¢ï¼Ÿ

**å¯¹æ•°å˜æ¢çš„ä¼˜ç‚¹**:
1. å‹ç¼©å¤§èŒƒå›´æ•°å€¼: 10^6 â†’ ~14
2. ä¿ç•™ç›¸å¯¹å…³ç³»: log(2x) = log(2) + log(x)
3. æ•°å€¼ç¨³å®š: é¿å…æµ®ç‚¹æº¢å‡º

**ä¸ºä»€ä¹ˆæ˜¯ log(x+1) è€Œä¸æ˜¯ log(x)**?
- å¤„ç†x=0çš„æƒ…å†µï¼ˆæŸäº›åŸå­å¯¹çš„LJå‚æ•°å¯èƒ½ä¸º0ï¼‰
- log(0) = -âˆï¼Œä¼šå¯¼è‡´é—®é¢˜
- log(1) = 0ï¼Œå®Œç¾å¤„ç†é›¶å€¼

### ä¸ºä»€ä¹ˆè§’åº¦/dihedralç”¨çº¿æ€§å½’ä¸€åŒ–ï¼Ÿ

1. å®ƒä»¬çš„èŒƒå›´æœ¬æ¥å°±ä¸å¤§ (0-180, 0-20)
2. çº¿æ€§å½’ä¸€åŒ–æ›´ç›´è§‚ï¼Œä¿ç•™ç‰©ç†æ„ä¹‰
3. ä¸ä¼šå¯¼è‡´æ•°å€¼æº¢å‡º

---

## âœ… éªŒè¯æ¸…å•

åœ¨å¼€å§‹è®­ç»ƒå‰ï¼Œç¡®è®¤ï¼š

- [ ] è¿è¡Œ `python scripts/03_build_dataset.py` é‡æ–°ç”Ÿæˆæ•°æ®
- [ ] è¿è¡Œ `python scripts/check_data_and_model.py` éªŒè¯æ•°æ®æ­£å¸¸
- [ ] ç¡®è®¤ nonbonded attributes çš„ max < 20
- [ ] ç¡®è®¤ model output ä¸åŒ…å« NaN
- [ ] ç¡®è®¤æ¢¯åº¦èŒƒæ•°åœ¨ 1-50 èŒƒå›´å†…

---

## ğŸ‰ æ€»ç»“

**æ ¹æœ¬åŸå› **: æ•°æ®é¢„å¤„ç†æ—¶æœªå½’ä¸€åŒ–ï¼Œå¯¼è‡´LJå‚æ•°è¿‡å¤§ (>10^6)

**è§£å†³æ–¹æ¡ˆ**: åœ¨æ•°æ®ç”Ÿæˆé˜¶æ®µå½’ä¸€åŒ–æ‰€æœ‰attributes

**æ•ˆæœ**:
- âœ… å®Œå…¨æ¶ˆé™¤NaNé—®é¢˜
- âœ… æ•°å€¼ç¨³å®šï¼Œå¯æ­£å¸¸è®­ç»ƒ
- âœ… æ¨¡å‹ä»£ç ç®€åŒ–ï¼ˆå›é€€äº†ä¸å¿…è¦çš„å¤æ‚ä¿®æ”¹ï¼‰

**å…³é”®æ•™è®­**:
> æ•°æ®é—®é¢˜è¦åœ¨æ•°æ®å±‚é¢è§£å†³ï¼Œè€Œä¸æ˜¯åœ¨æ¨¡å‹å±‚é¢æ‰“è¡¥ä¸ï¼

---

## ğŸ“ å¦‚æœè¿˜æœ‰é—®é¢˜

å¦‚æœé‡æ–°ç”Ÿæˆæ•°æ®å¹¶è®­ç»ƒåä»æœ‰NaN:

1. è¿è¡Œ `python scripts/check_data_and_model.py` å¹¶å‘é€å®Œæ•´è¾“å‡º
2. æ£€æŸ¥ nonbonded_edge_attr çš„æœ€å¤§å€¼æ˜¯å¦ < 20
3. å¦‚æœä» > 100ï¼Œè¯´æ˜å½’ä¸€åŒ–æ²¡æœ‰ç”Ÿæ•ˆï¼Œæ£€æŸ¥ä»£ç æ˜¯å¦æ­£ç¡®æ›´æ–°
